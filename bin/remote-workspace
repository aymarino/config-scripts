#!/usr/bin/env bash

invoke_fzf() {
    selection=$(fzf --ansi --header "$1" <<< "$2")
    if [[ -z "$selection" ]]; then
        exit 2 # No value selected
    fi
}

dev_desktop_hostname="dev"
workspace_root="/workplace/$USER"
workspaces=$(ssh -t $dev_desktop_hostname "ls $workspace_root | tr '\n' ' '" \
    2> /dev/null \
    | tr ' ' '\n' \
)
if [[ $? -ne 0 ]]; then
    echo "Error retrieving DevDesktop version sets; try running mwinit"
    exit 1
fi

invoke_fzf "Select a workspace" "$workspaces"
full_path="$workspace_root/$selection"

options="vscode ssh"
invoke_fzf "Select tool" "$(echo $options | tr ' ' '\n')"
case $selection in
    vscode)
        echo "Opening $full_path in VSCode remote..."
        code --remote ssh-remote+$dev_desktop_hostname $full_path
        ;;
    ssh)
        echo "Opening $full_path in current terminal..."
        ssh -t $dev_desktop_hostname "cd $full_path; exec \$SHELL -l"
        ;;
esac
